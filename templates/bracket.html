<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>March Madness Bracket</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/bracket.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ‚îÄ‚îÄ CONTROLS BAR ‚îÄ‚îÄ */
        .bracket-controls {
            background: #0033a0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 3px solid #001f7a;
            position: relative;
            z-index: 200;
        }

        .bracket-controls h1 {
            margin: 0;
            font-size: 22px;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }

        .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ‚îÄ‚îÄ STRATEGY TRIGGER BUTTON ‚îÄ‚îÄ */
        .strategy-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.12);
            border: 1.5px solid rgba(255,255,255,0.28);
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            transition: background 0.15s, border-color 0.15s;
            user-select: none;
            white-space: nowrap;
        }
        .strategy-trigger:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); }
        .strategy-trigger.open  { background: rgba(255,255,255,0.22); border-color: #fff; }

        .strategy-trigger .chevron {
            font-size: 9px;
            opacity: 0.7;
            transition: transform 0.2s;
        }
        .strategy-trigger.open .chevron { transform: rotate(180deg); }

        /* ‚îÄ‚îÄ DROPDOWN PANEL ‚îÄ‚îÄ */
        .strategy-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 480px;
            background: #0d1a3a;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.65);
            z-index: 1000;
            overflow: hidden;
            display: none;
        }
        .strategy-panel.open {
            display: block;
            animation: panelIn 0.17s ease forwards;
        }
        @keyframes panelIn {
            from { opacity: 0; transform: translateY(-6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            padding: 13px 16px 11px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            font-size: 10px;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.35);
            font-family: 'DM Sans', sans-serif;
        }

        /* ‚îÄ‚îÄ STRATEGY CARDS ‚îÄ‚îÄ */
        .strategy-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px 12px 8px;
        }

        .strategy-card {
            background: rgba(255,255,255,0.04);
            border: 1.5px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 13px 13px 11px;
            cursor: pointer;
            transition: background 0.14s, border-color 0.14s, transform 0.1s;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .strategy-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        .strategy-card.selected {
            background: rgba(77,138,255,0.14);
            border-color: #4d8aff;
        }

        /* Simulation spans full width */
        .strategy-card.wide { grid-column: 1 / -1; }

        .card-top {
            display: flex;
            align-items: center;
            gap: 9px;
        }
        .card-icon { font-size: 22px; line-height: 1; flex-shrink: 0; }

        .card-title {
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: 13px;
            color: #fff;
        }
        .card-tag {
            font-size: 9px;
            font-family: monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.4);
            display: inline-block;
            margin-top: 1px;
        }
        .strategy-card.selected .card-tag {
            background: rgba(77,138,255,0.2);
            color: #7ab4ff;
        }
        .card-desc {
            font-size: 11.5px;
            color: rgba(255,255,255,0.4);
            font-family: 'DM Sans', sans-serif;
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ PANEL FOOTER ‚îÄ‚îÄ */
        .panel-footer {
            padding: 10px 12px;
            border-top: 1px solid rgba(255,255,255,0.07);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-cancel {
            padding: 8px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 7px;
            color: rgba(255,255,255,0.55);
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background 0.15s;
            width: auto;
        }
        .btn-cancel:hover { background: rgba(255,255,255,0.11); }

        .btn-apply {
            padding: 8px 20px;
            background: linear-gradient(135deg, #0033a0, #0050e0);
            border: none;
            border-radius: 7px;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 6px;
            width: auto;
        }
        .btn-apply:hover:not(:disabled) { opacity: 0.88; transform: translateY(-1px); }
        .btn-apply:disabled { opacity: 0.35; cursor: not-allowed; }

        /* ‚îÄ‚îÄ SUBMIT BUTTON ‚îÄ‚îÄ */
        #submitBracketButton {
            padding: 9px 18px;
            background: #f0d060;
            color: #020b1f;
            font-size: 14px;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            white-space: nowrap;
        }
        #submitBracketButton:hover { background: #ffe066; transform: translateY(-1px); }

        #resetBracketButton {
            padding: 9px 16px;
            background: rgba(255,255,255,0.1);
            border: 1.5px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }
        #resetBracketButton:hover { background: rgba(255,255,255,0.2); }

        /* ‚îÄ‚îÄ LOADING SPINNER ‚îÄ‚îÄ */
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ BACKDROP ‚îÄ‚îÄ */
        .panel-backdrop {
            position: fixed;
            inset: 0;
            z-index: 999;
            display: none;
        }
        .panel-backdrop.open { display: block; }

        /* ‚îÄ‚îÄ SUBMIT MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 11, 31, 0.85);
            backdrop-filter: blur(6px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        .modal-box {
            background: #0d1a3a;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 32px 28px 28px;
            width: 400px;
            max-width: calc(100vw - 32px);
            box-shadow: 0 32px 80px rgba(0,0,0,0.6);
            transform: translateY(12px);
            transition: transform 0.2s;
        }
        .modal-overlay.open .modal-box {
            transform: translateY(0);
        }
        .modal-box h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            letter-spacing: 2px;
            color: #fff;
            margin: 0 0 6px;
        }
        .modal-box p {
            font-size: 13px;
            color: rgba(255,255,255,0.4);
            margin: 0 0 22px;
        }
        .modal-label {
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.35);
            font-family: 'DM Sans', sans-serif;
            display: block;
            margin-bottom: 8px;
        }
        .modal-input {
            width: 100%;
            background: rgba(255,255,255,0.06);
            border: 1.5px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            color: #e8eaf0;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            padding: 10px 14px;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        .modal-input:focus { border-color: #4d8aff; }
        .modal-char-count {
            font-size: 11px;
            color: rgba(255,255,255,0.2);
            text-align: right;
            margin-top: 4px;
            font-family: 'DM Sans', sans-serif;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .modal-cancel {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .modal-cancel:hover { background: rgba(255,255,255,0.1); }
        .modal-confirm {
            flex: 2;
            padding: 10px;
            background: #f0d060;
            border: none;
            border-radius: 8px;
            color: #020b1f;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s, opacity 0.15s;
        }
        .modal-confirm:hover { background: #ffe066; }
        .modal-confirm:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ‚îÄ‚îÄ NAV DIVIDER ‚îÄ‚îÄ */
        .nav-divider {
            width: 1px;
            height: 18px;
            background: rgba(255,255,255,0.18);
            margin: 0 2px;
            flex-shrink: 0;
        }

        @media (max-width: 600px) {
            .strategy-panel { width: calc(100vw - 24px); right: -12px; }
            .strategy-grid  { grid-template-columns: 1fr; }
            .strategy-card.wide { grid-column: 1; }
            .nav-divider { display: none; }
        }
    </style>
</head>
<body>

<!-- ========================= NAVBAR ========================= -->
<nav class="site-nav">
    <a href="/" class="nav-logo">üèÄ MM Bracket</a>
    <div class="nav-links">
        <a href="/"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></a>
        <a href="/bracket"><span class="nav-icon">‚ö°</span><span class="nav-label">Fill Bracket</span></a>
        {% if current_user.is_authenticated %}
        <a href="/my_brackets"><span class="nav-icon">üìã</span><span class="nav-label">My Brackets</span></a>
        {% endif %}
        <span class="nav-divider"></span>
        <a href="/leaderboard"><span class="nav-icon">üèÜ</span><span class="nav-label">Leaderboard</span></a>
        <a href="/rankings_stats"><span class="nav-icon">üìä</span><span class="nav-label">Rankings & Stats</span></a>
        <span class="nav-divider"></span>
        <a href="/help" class="active"><span class="nav-icon">‚ùì</span><span class="nav-label">Help</span></a>
        <a href="/contact"><span class="nav-icon">‚úâÔ∏è</span><span class="nav-label">Contact</span></a>
        <span class="nav-divider"></span>
        {% if current_user.is_authenticated %}
        <a href="/logout" class="btn-danger"><span class="nav-icon">üö™</span><span class="nav-label">Logout</span></a>
        {% else %}
        <a href="/login"><span class="nav-icon">üîë</span><span class="nav-label">Login</span></a>
        {% endif %}
    </div>
</nav>

<!-- ========================= BRACKET CONTROLS ========================= -->
<div class="bracket-controls">
    <h1>March Madness Bracket</h1>
    <div class="controls-right">

        <!-- STRATEGY PICKER -->
        <div style="position:relative;">
            <div class="strategy-trigger" id="strategyTrigger">
                <span>‚ö°</span>
                <span id="triggerLabel">Auto-fill Strategy</span>
                <span class="chevron">‚ñº</span>
            </div>

            <div class="panel-backdrop" id="panelBackdrop"></div>

            <div class="strategy-panel" id="strategyPanel">
                <div class="panel-header">Choose an auto-fill strategy</div>

                <div class="strategy-grid">

                    <div class="strategy-card"
                         data-strategy="chalk"
                         data-label="Chalk">
                        <div class="card-top">
                            <span class="card-icon">üèÖ</span>
                            <div>
                                <div class="card-title">Chalk</div>
                                <span class="card-tag">always favorites</span>
                            </div>
                        </div>
                        <div class="card-desc">Lower seed wins every matchup. Safe, predictable, statistically decent.</div>
                    </div>

                    <div class="strategy-card"
                         data-strategy="random"
                         data-label="Random">
                        <div class="card-top">
                            <span class="card-icon">üé≤</span>
                            <div>
                                <div class="card-title">Random</div>
                                <span class="card-tag">pure chaos</span>
                            </div>
                        </div>
                        <div class="card-desc">Completely random picks. Gloriously irresponsible.</div>
                    </div>

                    <div class="strategy-card"
                         data-strategy="probabilistic (by seed)"
                         data-label="Probabilistic">
                        <div class="card-top">
                            <span class="card-icon">üìä</span>
                            <div>
                                <div class="card-title">Probabilistic</div>
                                <span class="card-tag">by seed history</span>
                            </div>
                        </div>
                        <div class="card-desc">Historical seed win-rates drive every pick. Upsets happen at real-world frequencies.</div>
                    </div>

                    <div class="strategy-card"
                         data-strategy="by ranking"
                         data-label="By Ranking">
                        <div class="card-top">
                            <span class="card-icon">üìà</span>
                            <div>
                                <div class="card-title">By Ranking</div>
                                <span class="card-tag">team strength</span>
                            </div>
                        </div>
                        <div class="card-desc">Data-driven upset hunting.</div>
                    </div>

                    <div class="strategy-card wide"
                         data-strategy="simulation"
                         data-label="Simulation">
                        <div class="card-top">
                            <span class="card-icon">üß†</span>
                            <div>
                                <div class="card-title">Simulation</div>
                                <span class="card-tag">balanced model</span>
                            </div>
                        </div>
                        <div class="card-desc">Blends team strength ratings with historical seed probabilities for a balanced, realistic bracket.</div>
                    </div>

                </div>

                <div class="panel-footer">
                    <button class="btn-cancel" id="panelCancel">Cancel</button>
                    <button class="btn-apply" id="panelApply" disabled>
                        <span id="applyLabel">‚ö° Auto-fill</span>
                    </button>
                </div>
            </div>
        </div>

        <button id="resetBracketButton">‚Ü∫ Reset</button>
        <button id="saveBracketButton">üíæ Save</button>
        <button id="submitBracketButton">‚úÖ Submit</button>
    </div>
</div>

<!-- ========================= BRACKET ========================= -->
<div id="bracketContainer">
    <div class="bracket-region-tabs">
        <button class="bracket-region-tab active" data-region="south">South</button>
        <button class="bracket-region-tab" data-region="east">East</button>
        <button class="bracket-region-tab" data-region="west">West</button>
        <button class="bracket-region-tab" data-region="midwest">Midwest</button>
        <button class="bracket-region-tab" data-region="finalfour">Final Four</button>
    </div>

    <!-- South Region -->
    <div class="bracket-region-panel active" data-region="south">
        <div class="bracket-columns">
            <div class="bracket-column round-r64">
                <h3>Round of 64</h3>
                <div class="matchups" id="south_r64"></div>
            </div>
            <div class="bracket-column round-r32">
                <h3>Round of 32</h3>
                <div class="matchups" id="south_r32"></div>
            </div>
            <div class="bracket-column round-s16">
                <h3>Sweet 16</h3>
                <div class="matchups" id="south_s16"></div>
            </div>
            <div class="bracket-column round-e8">
                <h3>Elite 8</h3>
                <div class="matchups" id="south_e8"></div>
            </div>
        </div>
    </div>

    <!-- East Region -->
    <div class="bracket-region-panel" data-region="east">
        <div class="bracket-columns">
            <div class="bracket-column round-r64">
                <h3>Round of 64</h3>
                <div class="matchups" id="east_r64"></div>
            </div>
            <div class="bracket-column round-r32">
                <h3>Round of 32</h3>
                <div class="matchups" id="east_r32"></div>
            </div>
            <div class="bracket-column round-s16">
                <h3>Sweet 16</h3>
                <div class="matchups" id="east_s16"></div>
            </div>
            <div class="bracket-column round-e8">
                <h3>Elite 8</h3>
                <div class="matchups" id="east_e8"></div>
            </div>
        </div>
    </div>

    <!-- West Region -->
    <div class="bracket-region-panel" data-region="west">
        <div class="bracket-columns">
            <div class="bracket-column round-r64">
                <h3>Round of 64</h3>
                <div class="matchups" id="west_r64"></div>
            </div>
            <div class="bracket-column round-r32">
                <h3>Round of 32</h3>
                <div class="matchups" id="west_r32"></div>
            </div>
            <div class="bracket-column round-s16">
                <h3>Sweet 16</h3>
                <div class="matchups" id="west_s16"></div>
            </div>
            <div class="bracket-column round-e8">
                <h3>Elite 8</h3>
                <div class="matchups" id="west_e8"></div>
            </div>
        </div>
    </div>

    <!-- Midwest Region -->
    <div class="bracket-region-panel" data-region="midwest">
        <div class="bracket-columns">
            <div class="bracket-column round-r64">
                <h3>Round of 64</h3>
                <div class="matchups" id="midwest_r64"></div>
            </div>
            <div class="bracket-column round-r32">
                <h3>Round of 32</h3>
                <div class="matchups" id="midwest_r32"></div>
            </div>
            <div class="bracket-column round-s16">
                <h3>Sweet 16</h3>
                <div class="matchups" id="midwest_s16"></div>
            </div>
            <div class="bracket-column round-e8">
                <h3>Elite 8</h3>
                <div class="matchups" id="midwest_e8"></div>
            </div>
        </div>
    </div>

    <!-- Final Four -->
    <div class="bracket-region-panel final-four-panel" data-region="finalfour">
        <div class="bracket-columns final-four-columns">
            <div class="bracket-column round-ff round-ff-left">
                <h3>Semifinal</h3>
                <div class="matchups" id="ff_left"></div>
            </div>
            <div class="bracket-column round-champ round-champ-center">
                <h3>Championship</h3>
                <div class="matchups" id="championship"></div>
                <div class="national-champion">
                    <h3 style="margin-top:16px;">National Champion</h3>
                    <div class="champion" id="champion"></div>
                </div>
            </div>
            <div class="bracket-column round-ff round-ff-right">
                <h3>Semifinal</h3>
                <div class="matchups" id="ff_right"></div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ‚îÄ‚îÄ SAVE MODAL LOGIC ‚îÄ‚îÄ */
    const saveModal    = document.getElementById('saveModal');
    const saveNameInput = document.getElementById('saveNameInput');
    const saveCharCount = document.getElementById('saveCharCount');
    const saveCancelBtn = document.getElementById('saveCancelBtn');
    const saveConfirmBtn = document.getElementById('saveConfirmBtn');

    document.getElementById('saveBracketButton').addEventListener('click', () => {
        saveModal.classList.add('open');
        saveNameInput.value = '';
        saveCharCount.textContent = '0';
        saveNameInput.focus();
    });

    saveCancelBtn.addEventListener('click', () => saveModal.classList.remove('open'));

    saveModal.addEventListener('click', (e) => {
        if (e.target === saveModal) saveModal.classList.remove('open');
    });

    saveNameInput.addEventListener('input', () => {
        saveCharCount.textContent = saveNameInput.value.length;
    });

    saveNameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveConfirmBtn.click();
    });

    saveConfirmBtn.addEventListener('click', () => {
        const bracketName = saveNameInput.value.trim() || 'My Bracket';
        const bracketData = buildBracketJSON();

        saveConfirmBtn.disabled = true;
        saveConfirmBtn.textContent = 'Saving‚Ä¶';

        fetch('/save_bracket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bracket: bracketData, bracket_name: bracketName })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                saveModal.classList.remove('open');
                // Show a brief success toast, then optionally redirect
                const toast = document.createElement('div');
                toast.textContent = '‚úÖ Bracket saved!';
                toast.style.cssText = `
                    position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
                    background:#0033a0; color:#fff; padding:12px 24px; border-radius:8px;
                    font-family:'DM Sans',sans-serif; font-weight:700; font-size:14px;
                    z-index:9999; box-shadow:0 4px 16px rgba(0,0,0,0.3);
                    animation: fadeInUp 0.2s ease;
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2500);
            }
        })
        .catch(err => {
            console.error('Save failed:', err);
            alert('Save failed. Please try again.');
        })
        .finally(() => {
            saveConfirmBtn.disabled = false;
            saveConfirmBtn.textContent = 'üíæ Save Draft';
        });
    });
</script>

<!-- ========================= SAVE MODAL ========================= -->
<div class="modal-overlay" id="saveModal">
    <div class="modal-box">
        <h2>Save Bracket</h2>
        <p>Save your picks as a draft. You can view it on My Brackets and submit it to the leaderboard later.</p>
        <label class="modal-label" for="saveNameInput">Bracket Name</label>
        <input
            class="modal-input"
            id="saveNameInput"
            type="text"
            maxlength="50"
            placeholder="e.g. My Draft #1"
            autocomplete="off"
        >
        <div class="modal-char-count"><span id="saveCharCount">0</span> / 50</div>
        <div class="modal-actions">
            <button class="modal-cancel" id="saveCancelBtn">Cancel</button>
            <button class="modal-confirm" id="saveConfirmBtn">üíæ Save Draft</button>
        </div>
    </div>
</div>

<!-- ========================= SUBMIT MODAL ========================= -->
<div class="modal-overlay" id="submitModal">
    <div class="modal-box">
        <h2>Name Your Bracket</h2>
        <p>Give your bracket a name before locking it in.</p>
        <label class="modal-label" for="bracketNameInput">Bracket Name</label>
        <input
            class="modal-input"
            id="bracketNameInput"
            type="text"
            maxlength="50"
            placeholder="e.g. Duke All Day, Chaos Theory‚Ä¶"
            autocomplete="off"
        >
        <div class="modal-char-count"><span id="nameCharCount">0</span> / 50</div>
        <div class="modal-actions">
            <button class="modal-cancel" id="modalCancel">Cancel</button>
            <button class="modal-confirm" id="modalConfirm">üèÄ Lock It In</button>
        </div>
    </div>
</div>

<!-- ========================= JS ========================= -->
<script src="{{ url_for('static', filename='js/bracket.js') }}"></script>
<script src="{{ url_for('static', filename='js/autofill.js') }}"></script>

<script>
    /* ‚îÄ‚îÄ INITIAL TEAM LOAD ‚îÄ‚îÄ */
    const initialTeams = {{ teams | tojson }};
    document.addEventListener("DOMContentLoaded", () => loadInitialTeams(initialTeams));

    /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
    let selectedStrategy = null;

    /* ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ */
    const trigger      = document.getElementById('strategyTrigger');
    const panel        = document.getElementById('strategyPanel');
    const backdrop     = document.getElementById('panelBackdrop');
    const applyBtn     = document.getElementById('panelApply');
    const cancelBtn    = document.getElementById('panelCancel');
    const applyLabel   = document.getElementById('applyLabel');
    const triggerLabel = document.getElementById('triggerLabel');

    /* ‚îÄ‚îÄ OPEN / CLOSE ‚îÄ‚îÄ */
    trigger.addEventListener('click', () => togglePanel());
    backdrop.addEventListener('click', closePanel);
    cancelBtn.addEventListener('click', closePanel);

    function togglePanel() {
        const isOpen = panel.classList.contains('open');
        isOpen ? closePanel() : openPanel();
    }

    function openPanel() {
        panel.classList.add('open');
        backdrop.classList.add('open');
        trigger.classList.add('open');
    }

    function closePanel() {
        panel.classList.remove('open');
        backdrop.classList.remove('open');
        trigger.classList.remove('open');
    }

    /* ‚îÄ‚îÄ CARD SELECTION ‚îÄ‚îÄ */
    document.querySelectorAll('.strategy-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedStrategy = card.getAttribute('data-strategy');
            applyBtn.disabled = false;
        });
    });

    /* ‚îÄ‚îÄ APPLY: run autofill then close ‚îÄ‚îÄ */
    applyBtn.addEventListener('click', () => {
        if (!selectedStrategy) return;
        closePanel();
        runAutofill(selectedStrategy);
    });

    /* ‚îÄ‚îÄ AUTOFILL FETCH ‚îÄ‚îÄ */
    function runAutofill(strategy) {
        // Update trigger label to show chosen strategy
        const card = document.querySelector(`.strategy-card[data-strategy="${strategy}"]`);
        if (card) triggerLabel.textContent = card.getAttribute('data-label');

        // Show loading state on the trigger
        trigger.innerHTML = `<span class="spinner"></span> <span>Filling‚Ä¶</span>`;
        trigger.style.pointerEvents = 'none';

        fetch("/autofill_bracket", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ strategy })
        })
        .then(res => {
            if (!res.ok) throw new Error("Server error: " + res.status);
            return res.json();
        })
        .then(data => {
            autofillBracket(data);
        })
        .catch(err => {
            console.error("Autofill failed:", err);
            alert("Autofill failed. Check the console for details.");
        })
        .finally(() => {
            // Restore trigger
            trigger.innerHTML = `
                <span>‚ö°</span>
                <span id="triggerLabel">${card ? card.getAttribute('data-label') : 'Auto-fill Strategy'}</span>
                <span class="chevron">‚ñº</span>`;
            trigger.style.pointerEvents = '';
        });
    }

    /* ‚îÄ‚îÄ SUBMIT MODAL LOGIC ‚îÄ‚îÄ */
    const submitModal  = document.getElementById('submitModal');
    const nameInput    = document.getElementById('bracketNameInput');
    const charCount    = document.getElementById('nameCharCount');
    const modalCancel  = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    document.getElementById('submitBracketButton').addEventListener('click', () => {
        const { valid, missing } = validateAllPicks();
        if (!valid) {
            alert(`Please complete all matchups before submitting.\n\nMissing picks:\n‚Ä¢ ${missing.join('\n‚Ä¢ ')}`);
            return;
        }
        submitModal.classList.add('open');
        nameInput.value = '';
        charCount.textContent = '0';
        nameInput.focus();
    });

    document.getElementById('resetBracketButton').addEventListener('click', () => {
        resetBracket();
    });

    modalCancel.addEventListener('click', () => submitModal.classList.remove('open'));

    submitModal.addEventListener('click', (e) => {
        if (e.target === submitModal) submitModal.classList.remove('open');
    });

    nameInput.addEventListener('input', () => {
        charCount.textContent = nameInput.value.length;
    });

    nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') modalConfirm.click();
    });

    modalConfirm.addEventListener('click', () => {
        const bracketName = nameInput.value.trim() || 'My Bracket';
        const bracketData = buildBracketJSON();

        modalConfirm.disabled = true;
        modalConfirm.textContent = 'Submitting‚Ä¶';

        fetch("/submit_bracket", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bracket: bracketData, bracket_name: bracketName })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                submitModal.classList.remove('open');
                window.location.href = '/my_brackets';
            }
        })
        .catch(err => {
            console.error("Submit failed:", err);
            alert("Submission failed. Try again.");
        })
        .finally(() => {
            modalConfirm.disabled = false;
            modalConfirm.textContent = 'üèÄ Lock It In';
        });
    });
</script>

</body>
</html>