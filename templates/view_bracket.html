<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Bracket | March Madness</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/bracket.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ‚îÄ‚îÄ NAV DIVIDER (matches bracket.html) ‚îÄ‚îÄ */
        .nav-divider {
            width: 1px; height: 18px;
            background: rgba(255,255,255,0.18);
            margin: 0 2px; flex-shrink: 0;
        }
        @media (max-width: 600px) { .nav-divider { display: none; } }

        /* ‚îÄ‚îÄ CONTROLS BAR ‚Äî identical to bracket.html ‚îÄ‚îÄ */
        .bracket-controls {
            background: #0033a0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 3px solid #001f7a;
            position: sticky;
            top: 64px;
            z-index: 200;
        }
        .bracket-controls h1 {
            margin: 0;
            font-size: 22px;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }
        .controls-right { display: flex; align-items: center; gap: 10px; }

        /* Bracket switcher tabs sit in the controls bar left side */
        .bracket-tab {
            padding: 7px 16px;
            background: rgba(255,255,255,0.1);
            border: 1.5px solid rgba(255,255,255,0.2);
            border-radius: 7px;
            color: rgba(255,255,255,0.75);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .bracket-tab:hover { background: rgba(255,255,255,0.18); color: #fff; }
        .bracket-tab.active { background: #fff; color: #0033a0; border-color: #fff; }

        /* Score pill ‚Äî matches submit button styling */
        .score-pill {
            background: rgba(240,208,96,0.15);
            border: 1px solid rgba(240,208,96,0.35);
            border-radius: 20px;
            padding: 6px 18px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px; color: #f0d060; letter-spacing: 2px;
            white-space: nowrap;
        }
        .score-pill small {
            font-family: 'DM Sans', sans-serif; font-size: 10px;
            color: rgba(240,208,96,0.5); letter-spacing: 2px;
            text-transform: uppercase; margin-right: 6px;
        }

        /* Locked badge ‚Äî mirrors the autofill trigger style */
        .locked-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 14px;
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px; font-weight: 600;
            color: rgba(255,255,255,0.45);
            font-family: 'DM Sans', sans-serif;
            white-space: nowrap;
        }

        /* New bracket CTA */
        .btn-new-bracket {
            padding: 9px 18px;
            background: #f0d060;
            color: #020b1f;
            font-size: 14px; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: none; border-radius: 8px;
            text-decoration: none;
            transition: background 0.15s;
            white-space: nowrap;
        }
        .btn-new-bracket:hover { background: #ffe066; }

        /* ‚îÄ‚îÄ PANEL VISIBILITY ‚îÄ‚îÄ */
        .bracket-panel { display: none; }
        .bracket-panel.active { display: block; }

        /* ‚îÄ‚îÄ LOCK ALL BRACKET INTERACTIONS ‚îÄ‚îÄ */
        .bracket-panel #bracketContainer {
            pointer-events: none;
            user-select: none;
        }
        .bracket-region-tabs { pointer-events: auto; }

        /* Region tabs dark theme */
        .bracket-region-tab {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
            color: #0033a0;
        }
        .bracket-region-tab:hover { background: rgba(255,255,255,0.18); }
        .bracket-region-tab.active {
            background: rgba(255,255,255,0.95);
            color: #0033a0;
            border-color: #0033a0;
        }

        /* ‚îÄ‚îÄ BUST ACTUAL LABEL ‚îÄ‚îÄ */
        .bust-actual {
            color: #dc2626;
            margin-left: 4px;
        }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state { text-align: center; padding: 100px 20px; }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px; letter-spacing: 2px; margin-bottom: 10px;
        }
        .empty-state p { color: rgba(0,0,0,0.4); margin-bottom: 24px; font-size: 15px; }
        .empty-state a {
            display: inline-block; padding: 12px 28px;
            background: #0033a0; color: #fff; border-radius: 8px;
            text-decoration: none; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
        }
    </style>
</head>
<body>

<!-- ========================= NAVBAR ========================= -->
<nav class="site-nav">
    <a href="/" class="nav-logo">üèÄ MM Bracket</a>
    <div class="nav-links">
        <a href="/"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></a>
        <a href="/bracket"><span class="nav-icon">‚ö°</span><span class="nav-label">Fill Bracket</span></a>
        {% if current_user.is_authenticated %}
        <a href="/my_brackets"><span class="nav-icon">üìã</span><span class="nav-label">My Brackets</span></a>
        <a href="/my_groups"><span class="nav-icon">üë•</span><span class="nav-label">My Groups</span></a>
        {% endif %}
        <span class="nav-divider"></span>
        <a href="/leaderboard"><span class="nav-icon">üèÜ</span><span class="nav-label">Leaderboard</span></a>
        <a href="/rankings_stats"><span class="nav-icon">üìä</span><span class="nav-label">Rankings & Stats</span></a>
        <span class="nav-divider"></span>
        <a href="/help" class="active"><span class="nav-icon">‚ùì</span><span class="nav-label">Help</span></a>
        <a href="/contact"><span class="nav-icon">‚úâÔ∏è</span><span class="nav-label">Contact</span></a>
        <span class="nav-divider"></span>
        {% if current_user.is_authenticated %}
        <a href="/logout" class="btn-danger"><span class="nav-icon">üö™</span><span class="nav-label">Logout</span></a>
        {% else %}
        <a href="/login"><span class="nav-icon">üîë</span><span class="nav-label">Login</span></a>
        {% endif %}
    </div>
</nav>

{% if brackets %}

<!-- ========================= CONTROLS BAR ========================= -->
<div class="bracket-controls">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h1 id="activeName">{{ brackets[0].bracket_name }}</h1>
        {% if brackets|length > 1 %}
        <div style="display:flex;gap:6px;">
            {% for b in brackets %}
            <button class="bracket-tab {% if loop.first %}active{% endif %}"
                    data-id="{{ b.id }}"
                    data-name="{{ b.bracket_name }}"
                    data-score="{{ b.score }}">
                {{ b.bracket_name }}
            </button>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div class="controls-right">
        {% if brackets|length < 2 %}
        <a href="/bracket" class="btn-new-bracket">‚ûï New Bracket</a>
        {% endif %}
        <span class="locked-badge">üîí Submitted</span>
        <div class="score-pill" id="activeScore"><small>Score</small>{{ brackets[0].score }}</div>
    </div>
</div>

<!-- ========================= BRACKET PANELS ========================= -->
{% for b in brackets %}
<div class="bracket-panel {% if loop.first %}active{% endif %}" id="panel-{{ b.id }}">
<div id="bracketContainer" class="bracket-container-inner">
    <div class="bracket-region-tabs">
        <button class="bracket-region-tab active" data-region="south">South</button>
        <button class="bracket-region-tab" data-region="east">East</button>
        <button class="bracket-region-tab" data-region="west">West</button>
        <button class="bracket-region-tab" data-region="midwest">Midwest</button>
        <button class="bracket-region-tab" data-region="finalfour">Final Four</button>
    </div>
    <div class="bracket-region-panel active" data-region="south">
        <div class="bracket-columns">
            <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="south_r64_{{ b.id }}"></div></div>
            <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="south_r32_{{ b.id }}"></div></div>
            <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="south_s16_{{ b.id }}"></div></div>
            <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="south_e8_{{ b.id }}"></div></div>
        </div>
    </div>
    <div class="bracket-region-panel" data-region="east">
        <div class="bracket-columns">
            <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="east_r64_{{ b.id }}"></div></div>
            <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="east_r32_{{ b.id }}"></div></div>
            <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="east_s16_{{ b.id }}"></div></div>
            <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="east_e8_{{ b.id }}"></div></div>
        </div>
    </div>
    <div class="bracket-region-panel" data-region="west">
        <div class="bracket-columns">
            <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="west_r64_{{ b.id }}"></div></div>
            <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="west_r32_{{ b.id }}"></div></div>
            <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="west_s16_{{ b.id }}"></div></div>
            <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="west_e8_{{ b.id }}"></div></div>
        </div>
    </div>
    <div class="bracket-region-panel" data-region="midwest">
        <div class="bracket-columns">
            <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="midwest_r64_{{ b.id }}"></div></div>
            <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="midwest_r32_{{ b.id }}"></div></div>
            <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="midwest_s16_{{ b.id }}"></div></div>
            <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="midwest_e8_{{ b.id }}"></div></div>
        </div>
    </div>
    <div class="bracket-region-panel final-four-panel" data-region="finalfour">
        <div class="bracket-columns final-four-columns">
            <div class="bracket-column round-ff round-ff-left"><h3>Semifinal</h3><div class="matchups" id="ff_left_{{ b.id }}"></div></div>
            <div class="bracket-column round-champ round-champ-center">
                <h3>Championship</h3>
                <div class="matchups" id="championship_{{ b.id }}"></div>
                <div class="national-champion"><h3 style="margin-top:16px;">National Champion</h3><div class="champion" id="champion_{{ b.id }}"></div></div>
            </div>
            <div class="bracket-column round-ff round-ff-right"><h3>Semifinal</h3><div class="matchups" id="ff_right_{{ b.id }}"></div></div>
        </div>
    </div>
</div>
</div>
{% endfor %}

{% else %}
<div class="empty-state">
    <div class="icon">üìã</div>
    <h3>No Brackets Yet</h3>
    <p>You haven't submitted any brackets yet.</p>
    <a href="/bracket">‚ö° Fill My Bracket</a>
</div>
{% endif %}

<!-- ========================= JS ========================= -->
<script>
const allData     = {{ brackets | map(attribute='bracket_data') | list | tojson }};
const allIds      = {{ brackets | map(attribute='id')           | list | tojson }};
const trueResults = {{ (true_results or {}) | tojson }};

const ROUND_ORDER = [
    ["west_r64","west_r32"],["west_r32","west_s16"],["west_s16","west_e8"],["west_e8","ff_left"],
    ["south_r64","south_r32"],["south_r32","south_s16"],["south_s16","south_e8"],["south_e8","ff_left"],
    ["east_r64","east_r32"],["east_r32","east_s16"],["east_s16","east_e8"],["east_e8","ff_right"],
    ["midwest_r64","midwest_r32"],["midwest_r32","midwest_s16"],["midwest_s16","midwest_e8"],["midwest_e8","ff_right"],
    ["ff_left","championship"],["ff_right","championship"]
];
const CONTAINERS = [
    "west_r64","west_r32","west_s16","west_e8",
    "south_r64","south_r32","south_s16","south_e8",
    "east_r64","east_r32","east_s16","east_e8",
    "midwest_r64","midwest_r32","midwest_s16","midwest_e8",
    "ff_left","ff_right","championship"
];

const ROUND_DEPTH = {
    "west_r64": 0, "south_r64": 0, "east_r64": 0, "midwest_r64": 0,
    "west_r32": 1, "south_r32": 1, "east_r32": 1, "midwest_r32": 1,
    "west_s16": 2, "south_s16": 2, "east_s16": 2, "midwest_s16": 2,
    "west_e8":  3, "south_e8":  3, "east_e8":  3, "midwest_e8":  3,
    "ff_left":  4, "ff_right":  4,
    "championship": 5,
};

/* ‚îÄ‚îÄ Build the set of teams that are "busted" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   A team is busted if they lost in real life EARLIER than the user
   predicted. Only then do they get a strikethrough.
   Returns a Map: teamName ‚Üí depth at which they actually lost.
   The strikethrough is shown in rounds at that depth and later.           */

function buildBustedTeams(data) {
    const realSlotWinner = new Map();
    CONTAINERS.forEach(cid => {
        const realWinners = trueResults[cid];
        if (!realWinners) return;
        realWinners.forEach((w, i) => { if (w) realSlotWinner.set(`${cid}:${i}`, w); });
    });

    const realLostAt = new Map();
    CONTAINERS.forEach(cid => {
        const realWinners = trueResults[cid];
        if (!realWinners || !realWinners.length) return;
        const teams = data[cid];
        if (!teams || !teams.length) return;
        const depth = ROUND_DEPTH[cid];
        if (depth === undefined) return;
        for (let i = 0; i + 1 < teams.length; i += 2) {
            const realWinner = realWinners[i / 2];
            if (!realWinner) continue;
            const n1 = typeof teams[i]   === 'string' ? teams[i]   : teams[i]?.name;
            const n2 = typeof teams[i+1] === 'string' ? teams[i+1] : teams[i+1]?.name;
            if (n1 && n1 !== realWinner && !realLostAt.has(n1)) realLostAt.set(n1, depth);
            if (n2 && n2 !== realWinner && !realLostAt.has(n2)) realLostAt.set(n2, depth);
        }
    });

    const userLastRound = new Map();
    CONTAINERS.forEach(cid => {
        const depth = ROUND_DEPTH[cid];
        if (depth === undefined) return;
        (data[cid] || []).forEach(t => {
            const name = typeof t === 'string' ? t : t?.name;
            if (!name) return;
            if (!userLastRound.has(name) || depth > userLastRound.get(name)) userLastRound.set(name, depth);
        });
    });
    if (data.champion) {
        const n = data.champion, d = 6;
        if (!userLastRound.has(n) || d > userLastRound.get(n)) userLastRound.set(n, d);
    }

    const busted = new Map();
    realLostAt.forEach((lostDepth, name) => {
        if (lostDepth < (userLastRound.get(name) ?? lostDepth)) busted.set(name, lostDepth);
    });
    return { busted, realSlotWinner };
}

function teamClasses(w1, w2, n1, n2, slotIndex, cid, bustedData) {
    const { busted } = bustedData;
    const userPick = w1 ? n1 : w2 ? n2 : null;
    const actualWinner = (trueResults[cid] || [])[slotIndex];
    let c1 = '', c2 = '', check1 = false, check2 = false;
    if (actualWinner) {
        const correct = userPick === actualWinner;
        c1 = (correct && n1 === userPick) ? ' correct' : (!correct && n1 === actualWinner) ? ' incorrect-actual' : '';
        c2 = (correct && n2 === userPick) ? ' correct' : (!correct && n2 === actualWinner) ? ' incorrect-actual' : '';
        check1 = correct && n1 === userPick;
        check2 = correct && n2 === userPick;
    }
    const depth = ROUND_DEPTH[cid] ?? -1;
    const bust1 = busted.has(n1) && depth > busted.get(n1);
    const bust2 = busted.has(n2) && depth > busted.get(n2);
    if (bust1) c1 += ' busted';
    if (bust2) c2 += ' busted';
    // Red label = whoever actually won the PREVIOUS round's feeder game for this position.
    // Each slot in the current round has two feeder games from the previous round:
    //   top team in slot S came from previous round slot S*2
    //   bottom team in slot S came from previous round slot S*2+1
    // Never show in R64 (depth 0).
    const getRealBustLabel = (name, bust, teamPos) => {
        if (!bust || depth === 0) return null;
        const PREV_ROUND_FOR_POS = {
            west_r32:    (s, p) => ({ cid: 'west_r64',    slot: s * 2 + p }),
            west_s16:    (s, p) => ({ cid: 'west_r32',    slot: s * 2 + p }),
            west_e8:     (s, p) => ({ cid: 'west_s16',    slot: s * 2 + p }),
            south_r32:   (s, p) => ({ cid: 'south_r64',   slot: s * 2 + p }),
            south_s16:   (s, p) => ({ cid: 'south_r32',   slot: s * 2 + p }),
            south_e8:    (s, p) => ({ cid: 'south_s16',   slot: s * 2 + p }),
            east_r32:    (s, p) => ({ cid: 'east_r64',    slot: s * 2 + p }),
            east_s16:    (s, p) => ({ cid: 'east_r32',    slot: s * 2 + p }),
            east_e8:     (s, p) => ({ cid: 'east_s16',    slot: s * 2 + p }),
            midwest_r32: (s, p) => ({ cid: 'midwest_r64', slot: s * 2 + p }),
            midwest_s16: (s, p) => ({ cid: 'midwest_r32', slot: s * 2 + p }),
            midwest_e8:  (s, p) => ({ cid: 'midwest_s16', slot: s * 2 + p }),
            ff_left:     (s, p) => ({ cid: p === 0 ? 'west_e8' : 'south_e8', slot: 0 }),
            ff_right:    (s, p) => ({ cid: p === 0 ? 'east_e8' : 'midwest_e8', slot: 0 }),
            championship:(s, p) => ({ cid: p === 0 ? 'ff_left' : 'ff_right', slot: 0 }),
        };
        const fn = PREV_ROUND_FOR_POS[cid];
        if (!fn) return null;
        const { cid: prevCid, slot: prevSlot } = fn(slotIndex, teamPos);
        const feederWinner = bustedData.realSlotWinner.get(`${prevCid}:${prevSlot}`);
        if (feederWinner && feederWinner !== name) return feederWinner;
        return null;
    };
    const bustLabel1 = getRealBustLabel(n1, bust1, 0);
    const bustLabel2 = getRealBustLabel(n2, bust2, 1);
    return { c1, c2, check1, check2, bustLabel1, bustLabel2 };
}

function renderBracket(data, bid) {
    const bustedData = buildBustedTeams(data);
    CONTAINERS.forEach(cid => {
        const teams = data[cid];
        if (!teams || !teams.length) return;
        const winners = new Set();
        ROUND_ORDER.filter(([c]) => c === cid).forEach(([, nxt]) => {
            (data[nxt] || []).forEach(t => winners.add(typeof t === 'string' ? t : t.name));
        });
        if (cid === 'championship' && data.champion) winners.add(data.champion);
        const container = document.getElementById(cid + '_' + bid);
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i + 1 < teams.length; i += 2) {
            const t1 = teams[i], t2 = teams[i+1];
            const n1 = typeof t1 === 'string' ? t1 : t1.name;
            const s1 = typeof t1 === 'string' ? '' : (t1.seed || '');
            const n2 = typeof t2 === 'string' ? t2 : t2.name;
            const s2 = typeof t2 === 'string' ? '' : (t2.seed || '');
            const w1 = winners.has(n1), w2 = winners.has(n2);
            const { c1, c2, check1, check2, bustLabel1, bustLabel2 } = teamClasses(w1, w2, n1, n2, i/2, cid, bustedData);
            const div = document.createElement('div');
            div.className = 'matchup';
            div.innerHTML =
                `<div class="team ${w1?'selected':w2?'eliminated':''}${c1}">
                    <span class="seed">${s1}</span><span class="team-name">${n1}</span>${check1?' <span class="check-mark">‚úì</span>':''}${bustLabel1?` <span class="bust-actual">${bustLabel1}</span>`:''}
                </div>` +
                `<div class="team ${w2?'selected':w1?'eliminated':''}${c2}">
                    <span class="seed">${s2}</span><span class="team-name">${n2}</span>${check2?' <span class="check-mark">‚úì</span>':''}${bustLabel2?` <span class="bust-actual">${bustLabel2}</span>`:''}
                </div>`;
            container.appendChild(div);
        }
    });
    const ch = document.getElementById('champion_' + bid);
    const actualChamp = (trueResults['championship'] || [])[0];
    if (ch && data.champion) {
        const champBusted = bustedData.busted.has(data.champion) && 6 >= bustedData.busted.get(data.champion);
        const nameHtml = champBusted
            ? `<span class="team-name" style="text-decoration:line-through;opacity:0.6;">${data.champion}</span>`
            : data.champion;
        ch.innerHTML = actualChamp && data.champion === actualChamp
            ? nameHtml + ' <span class="check-mark">‚úì</span>'
            : actualChamp && data.champion !== actualChamp
                ? nameHtml + ` <span class="bust-actual">${actualChamp}</span>`
                : nameHtml;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    allData.forEach((d, i) => renderBracket(d, allIds[i]));
});

/* Region tab switching (per bracket panel) */
document.querySelectorAll('.bracket-container-inner').forEach(container => {
    container.querySelectorAll('.bracket-region-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const region = tab.dataset.region;
            container.querySelectorAll('.bracket-region-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.bracket-region-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            const panel = container.querySelector(`.bracket-region-panel[data-region="${region}"]`);
            if (panel) panel.classList.add('active');
        });
    });
});

/* Bracket tab switching */
document.querySelectorAll('.bracket-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.bracket-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.bracket-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.id).classList.add('active');
        document.getElementById('activeName').textContent = btn.dataset.name;
        document.getElementById('activeScore').innerHTML = `<small>Score</small>${btn.dataset.score}`;
    });
});
</script>

</body>