<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Brackets | March Madness</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/bracket.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ‚îÄ‚îÄ NAV DIVIDER ‚îÄ‚îÄ */
        .nav-divider {
            width: 1px; height: 18px;
            background: rgba(255,255,255,0.18);
            margin: 0 2px; flex-shrink: 0;
        }
        @media (max-width: 600px) { .nav-divider { display: none; } }

        /* PAGE LAYOUT */
        .page-wrap {
            max-width: 960px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 40px;
        }
        .page-header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            letter-spacing: 3px;
            color: #0033a0;
            margin: 0;
        }

        .btn-new-bracket {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 11px 22px;
            background: #0033a0;
            color: #fff;
            font-size: 14px; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: none; border-radius: 8px;
            text-decoration: none;
            transition: background 0.15s;
            white-space: nowrap;
        }
        .btn-new-bracket:hover { background: #00246a; }

        /* SECTION HEADERS */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .section-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            letter-spacing: 2px;
            color: #0033a0;
            margin: 0;
        }
        .section-counter {
            font-family: 'DM Sans', sans-serif;
            font-size: 12px; font-weight: 700;
            color: rgba(0,51,160,0.5);
            background: rgba(0,51,160,0.08);
            border: 1px solid rgba(0,51,160,0.15);
            border-radius: 20px;
            padding: 3px 10px;
            letter-spacing: 1px;
        }

        /* SUBMITTED SLOTS */
        .submitted-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 48px;
        }
        @media (max-width: 600px) { .submitted-grid { grid-template-columns: 1fr; } }

        .submitted-slot {
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid #0033a0;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0,51,160,0.08);
        }
        .submitted-slot.empty {
            border: 2px dashed rgba(0,51,160,0.2);
            background: rgba(0,51,160,0.02);
            box-shadow: none;
        }

        .slot-header {
            background: #0033a0;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slot-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: rgba(255,255,255,0.35);
            letter-spacing: 2px;
            line-height: 1;
        }
        .slot-name {
            font-family: 'DM Sans', sans-serif;
            font-size: 15px; font-weight: 700;
            color: #fff;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .slot-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: #f0d060;
            letter-spacing: 2px;
            line-height: 1;
        }

        .slot-body {
            padding: 16px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .slot-meta {
            font-size: 12px;
            color: rgba(0,0,0,0.35);
            font-family: 'DM Sans', sans-serif;
        }
        .slot-meta strong { color: rgba(0,0,0,0.55); }

        .btn-view {
            padding: 7px 16px;
            background: #0033a0;
            color: #fff;
            font-size: 13px; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: none; border-radius: 7px;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }
        .btn-view:hover { background: #00246a; }

        .submitted-slot.empty .slot-header {
            background: rgba(0,51,160,0.1);
        }
        .submitted-slot.empty .slot-num { color: rgba(0,51,160,0.2); }

        .empty-slot-body {
            padding: 20px 18px;
            text-align: center;
        }
        .empty-slot-body p {
            color: rgba(0,0,0,0.3);
            font-size: 13px;
            margin-bottom: 14px;
        }
        .btn-submit-cta {
            display: inline-block;
            padding: 8px 20px;
            background: #0033a0;
            color: #fff;
            font-size: 13px; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: none; border-radius: 7px;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s;
        }
        .btn-submit-cta:hover { background: #00246a; }

        /* SAVED DRAFTS LIST */
        .saved-section { margin-top: 0; }

        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-row {
            display: flex;
            align-items: center;
            gap: 14px;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 10px;
            padding: 14px 18px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .saved-row:hover {
            border-color: rgba(0,51,160,0.25);
            box-shadow: 0 2px 8px rgba(0,51,160,0.08);
        }

        .saved-icon { font-size: 22px; flex-shrink: 0; opacity: 0.5; }

        .saved-name {
            flex: 1;
            font-size: 15px; font-weight: 700;
            color: #111;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .saved-champion {
            font-size: 12px;
            color: rgba(0,0,0,0.35);
            font-family: 'DM Sans', sans-serif;
            white-space: nowrap;
        }

        .saved-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .slot-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px; font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-sm-view   { background: rgba(0,51,160,0.08); color: #0033a0; }
        .btn-sm-view:hover   { background: rgba(0,51,160,0.15); }
        .btn-sm-submit { background: #0033a0; color: #fff; }
        .btn-sm-submit:hover { background: #00246a; }
        .btn-sm-delete { background: rgba(220,38,38,0.08); color: #dc2626; }
        .btn-sm-delete:hover { background: rgba(220,38,38,0.15); }
        .btn-sm:disabled { opacity: 0.35; cursor: not-allowed; }

        /* EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: rgba(0,0,0,0.3);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; margin-bottom: 20px; }

        /* SUBMIT MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }

        .modal-box {
            background: #0d1a3a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 32px;
            width: 380px;
            max-width: calc(100vw - 32px);
            color: #e8eaf0;
        }
        .modal-box h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 30px; letter-spacing: 2px;
            margin-bottom: 6px;
        }
        .modal-box p {
            font-size: 14px;
            color: rgba(255,255,255,0.45);
            margin-bottom: 22px;
            line-height: 1.5;
        }
        .modal-label {
            font-size: 12px; font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.4);
            display: block;
            margin-bottom: 8px;
        }
        .modal-input {
            width: 100%;
            background: rgba(255,255,255,0.06);
            border: 1.5px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            color: #e8eaf0;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            padding: 10px 14px;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        .modal-input:focus { border-color: #4d8aff; }
        .modal-char-count {
            font-size: 11px;
            color: rgba(255,255,255,0.2);
            text-align: right;
            margin-top: 4px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .modal-cancel {
            flex: 1; padding: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px; font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .modal-cancel:hover { background: rgba(255,255,255,0.1); }
        .modal-confirm {
            flex: 2; padding: 10px;
            background: #f0d060;
            border: none;
            border-radius: 8px;
            color: #020b1f;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px; font-weight: 700;
            cursor: pointer;
            transition: background 0.15s, opacity 0.15s;
        }
        .modal-confirm:hover { background: #ffe066; }
        .modal-confirm:disabled { opacity: 0.4; cursor: not-allowed; }

        /* BRACKET VIEWER */
        .viewer-section { margin-top: 56px; }

        .viewer-section-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(0,51,160,0.12);
        }
        .viewer-section-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px; letter-spacing: 2px;
            color: #0033a0;
            margin: 0;
        }

        .bracket-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .bracket-tab {
            padding: 7px 16px;
            background: rgba(0,51,160,0.07);
            border: 1.5px solid rgba(0,51,160,0.2);
            border-radius: 7px;
            color: #0033a0;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .bracket-tab:hover { background: rgba(0,51,160,0.12); }
        .bracket-tab.active { background: #0033a0; color: #fff; border-color: #0033a0; }

        .tab-badge {
            display: inline-block;
            background: rgba(240,208,96,0.25);
            color: #8a6900;
            font-size: 10px; font-weight: 700;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
        .bracket-tab.active .tab-badge {
            background: rgba(240,208,96,0.35);
            color: #f0d060;
        }

        .bracket-panel { display: none; }
        .bracket-panel.active { display: block; }

        .bracket-panel .bracket-container-inner {
            pointer-events: none;
            user-select: none;
        }
        .bracket-region-tabs { pointer-events: auto; }

        .bracket-region-tab {
            background: rgba(0,51,160,0.08);
            border-color: rgba(0,51,160,0.2);
            color: #0033a0;
        }
        .bracket-region-tab:hover { background: rgba(0,51,160,0.15); }
        .bracket-region-tab.active {
            background: #fff;
            color: #0033a0;
            border-color: #0033a0;
        }

        .bust-actual {
            color: #dc2626;
            margin-left: 4px;
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="site-nav">
    <a href="/" class="nav-logo">üèÄ MM Bracket</a>
    <div class="nav-links">
        <a href="/"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></a>
        <a href="/bracket"><span class="nav-icon">‚ö°</span><span class="nav-label">Fill Bracket</span></a>
        {% if current_user.is_authenticated %}
        <a href="/my_brackets"><span class="nav-icon">üìã</span><span class="nav-label">My Brackets</span></a>
        <a href="/my_groups"><span class="nav-icon">üë•</span><span class="nav-label">My Groups</span></a>
        {% endif %}
        <span class="nav-divider"></span>
        <a href="/leaderboard"><span class="nav-icon">üèÜ</span><span class="nav-label">Leaderboard</span></a>
        <a href="/rankings_stats"><span class="nav-icon">üìä</span><span class="nav-label">Rankings & Stats</span></a>
        <span class="nav-divider"></span>
        <a href="/help" class="active"><span class="nav-icon">‚ùì</span><span class="nav-label">Help</span></a>
        <a href="/contact"><span class="nav-icon">‚úâÔ∏è</span><span class="nav-label">Contact</span></a>
        <span class="nav-divider"></span>
        {% if current_user.is_authenticated %}
        <a href="/logout" class="btn-danger"><span class="nav-icon">üö™</span><span class="nav-label">Logout</span></a>
        {% else %}
        <a href="/login"><span class="nav-icon">üîë</span><span class="nav-label">Login</span></a>
        {% endif %}
    </div>
</nav>

<div class="page-wrap">

    {% set total_count = (submitted|length) + (saved|length) %}

    <!-- PAGE HEADER -->
    <div class="page-header">
        <h1>My Brackets</h1>
        <a href="/bracket" class="btn-new-bracket">‚ö° Build New Bracket</a>
    </div>

    <!-- ‚ïê‚ïê‚ïê SUBMITTED BRACKETS ‚ïê‚ïê‚ïê -->
    <div class="section-header">
        <h2>Submitted</h2>
        <span class="section-counter">{{ submitted|length }} / 2</span>
    </div>

    <div class="submitted-grid">
        {% for i in range(2) %}
        {% if i < submitted|length %}
            {% set b = submitted[i] %}
            <div class="submitted-slot">
                <div class="slot-header">
                    <span class="slot-num">#{{ i + 1 }}</span>
                    <span class="slot-name">{{ b.bracket_name }}</span>
                    <span class="slot-score">{{ b.score }}</span>
                </div>
                <div class="slot-body">
                    <div class="slot-meta">
                        <strong>Champion:</strong>
                        {{ b.bracket_data.get('champion', '‚Äî') if b.bracket_data else '‚Äî' }}
                    </div>
                    <div class="saved-actions">
                        <div class="slot-actions">
                        <a href="#viewer" class="btn-view bracket-viewer-link" data-id="{{ b.id }}">View ‚Üí</a>
                        <button class="btn-sm btn-sm-view open-rename-modal-btn"
                                data-bracket-id="{{ b.id }}"
                                data-bracket-name="{{ b.bracket_name }}">‚úèÔ∏è Rename</button>
                    </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="submitted-slot empty">
                <div class="slot-header">
                    <span class="slot-num">#{{ i + 1 }}</span>
                    <span class="slot-name" style="color:rgba(0,51,160,0.3);font-weight:400;">Empty slot</span>
                </div>
                <div class="empty-slot-body">
                    {% if saved|length > 0 %}
                    <p>Submit a saved draft, or build a new bracket.</p>
                    {% else %}
                    <p>Build a bracket and submit it to the leaderboard.</p>
                    {% endif %}
                    <a href="/bracket" class="btn-submit-cta">‚ö° Build &amp; Submit</a>
                </div>
            </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- ‚ïê‚ïê‚ïê SAVED DRAFTS ‚ïê‚ïê‚ïê -->
    <div class="saved-section">
        <div class="section-header">
            <h2>Saved Drafts</h2>
            <span class="section-counter">{{ saved|length }} / 25</span>
        </div>

        {% if saved %}
        <div class="saved-list">
            {% for b in saved %}
            <div class="saved-row" id="saved-row-{{ b.id }}">
                <span class="saved-icon">üìÑ</span>
                <span class="saved-name">{{ b.bracket_name }}</span>
                <span class="saved-champion">üèÄ {{ b.bracket_data.get('champion', 'No champion') if b.bracket_data else 'No champion' }}</span>
                <div class="saved-actions">
                    <a href="#viewer" class="btn-sm btn-sm-view bracket-viewer-link" data-id="{{ b.id }}">View</a>
                    <button class="btn-sm btn-sm-view open-rename-modal-btn"
                            data-bracket-id="{{ b.id }}"
                            data-bracket-name="{{ b.bracket_name }}">‚úèÔ∏è Rename</button>
                    {% if submitted|length < 2 %}
                    <button class="btn-sm btn-sm-submit open-submit-modal-btn"
                            data-bracket-id="{{ b.id }}"
                            data-bracket-name="{{ b.bracket_name }}">
                        üèÜ Submit
                    </button>
                    {% else %}
                    <button class="btn-sm btn-sm-submit" disabled title="Already submitted 2 brackets">
                        üèÜ Submit
                    </button>
                    {% endif %}
                    <button class="btn-sm btn-sm-delete" onclick="deleteBracket({{ b.id }}, this)">üóë</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="icon">üìù</div>
            <p>No saved drafts yet. Build a bracket and save it to work on it later.</p>
            <a href="/bracket" class="btn-new-bracket" style="display:inline-flex;">‚ö° Build a Bracket</a>
        </div>
        {% endif %}
    </div>

    <!-- ‚ïê‚ïê‚ïê BRACKET VIEWER ‚ïê‚ïê‚ïê -->
    {% set all_viewable = submitted + saved %}
    {% if all_viewable %}
    <div class="viewer-section" id="viewer">
        <div class="viewer-section-header">
            <h2 id="viewerTitle">{{ all_viewable[0].bracket_name }}</h2>
            <div class="bracket-tabs">
                {% for b in all_viewable %}
                <button class="bracket-tab {% if loop.first %}active{% endif %}"
                        data-id="{{ b.id }}"
                        data-name="{{ b.bracket_name }}">
                    {{ b.bracket_name }}{% if b.is_submitted %}<span class="tab-badge">{{ b.score }}pts</span>{% endif %}
                </button>
                {% endfor %}
            </div>
        </div>

        {% for b in all_viewable %}
        <div class="bracket-panel {% if loop.first %}active{% endif %}" id="panel-{{ b.id }}">
            <div class="bracket-container-inner">
                <div class="bracket-region-tabs">
                    <button class="bracket-region-tab active" data-region="south">South</button>
                    <button class="bracket-region-tab" data-region="east">East</button>
                    <button class="bracket-region-tab" data-region="west">West</button>
                    <button class="bracket-region-tab" data-region="midwest">Midwest</button>
                    <button class="bracket-region-tab" data-region="finalfour">Final Four</button>
                </div>
                <div class="bracket-region-panel active" data-region="south">
                    <div class="bracket-columns">
                        <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="south_r64_{{ b.id }}"></div></div>
                        <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="south_r32_{{ b.id }}"></div></div>
                        <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="south_s16_{{ b.id }}"></div></div>
                        <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="south_e8_{{ b.id }}"></div></div>
                    </div>
                </div>
                <div class="bracket-region-panel" data-region="east">
                    <div class="bracket-columns">
                        <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="east_r64_{{ b.id }}"></div></div>
                        <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="east_r32_{{ b.id }}"></div></div>
                        <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="east_s16_{{ b.id }}"></div></div>
                        <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="east_e8_{{ b.id }}"></div></div>
                    </div>
                </div>
                <div class="bracket-region-panel" data-region="west">
                    <div class="bracket-columns">
                        <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="west_r64_{{ b.id }}"></div></div>
                        <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="west_r32_{{ b.id }}"></div></div>
                        <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="west_s16_{{ b.id }}"></div></div>
                        <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="west_e8_{{ b.id }}"></div></div>
                    </div>
                </div>
                <div class="bracket-region-panel" data-region="midwest">
                    <div class="bracket-columns">
                        <div class="bracket-column round-r64"><h3>Round of 64</h3><div class="matchups" id="midwest_r64_{{ b.id }}"></div></div>
                        <div class="bracket-column round-r32"><h3>Round of 32</h3><div class="matchups" id="midwest_r32_{{ b.id }}"></div></div>
                        <div class="bracket-column round-s16"><h3>Sweet 16</h3><div class="matchups" id="midwest_s16_{{ b.id }}"></div></div>
                        <div class="bracket-column round-e8"><h3>Elite 8</h3><div class="matchups" id="midwest_e8_{{ b.id }}"></div></div>
                    </div>
                </div>
                <div class="bracket-region-panel final-four-panel" data-region="finalfour">
                    <div class="bracket-columns final-four-columns">
                        <div class="bracket-column round-ff round-ff-left"><h3>Semifinal</h3><div class="matchups" id="ff_left_{{ b.id }}"></div></div>
                        <div class="bracket-column round-champ round-champ-center">
                            <h3>Championship</h3>
                            <div class="matchups" id="championship_{{ b.id }}"></div>
                            <div class="national-champion"><h3 style="margin-top:16px;">National Champion</h3><div class="champion" id="champion_{{ b.id }}"></div></div>
                        </div>
                        <div class="bracket-column round-ff round-ff-right"><h3>Semifinal</h3><div class="matchups" id="ff_right_{{ b.id }}"></div></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

</div><!-- /page-wrap -->

<!-- SUBMIT MODAL -->
<div class="modal-overlay" id="submitModal">
    <div class="modal-box">
        <h2>Lock It In</h2>
        <p>This bracket will be submitted to the leaderboard. You have <strong id="slotsLeft" style="color:#f0d060;">{{ 2 - submitted|length }}</strong> slot(s) remaining.<br><strong style="color:#ffd1a8;">Once bracket is submitted it cannot be changed or unsubmitted</strong></p>
        <input type="hidden" id="submitBracketId" value="">
        <label class="modal-label">Bracket Name</label>
        <input class="modal-input" id="submitBracketName" type="text" maxlength="50">
        <div class="modal-char-count"><span id="submitCharCount">0</span> / 50</div>
        <div class="modal-actions">
            <button class="modal-cancel" id="modalCancel">Cancel</button>
            <button class="modal-confirm" id="modalConfirm">üèÜ Submit to Leaderboard</button>
        </div>
    </div>
</div>

<!-- RENAME MODAL -->
<div class="modal-overlay" id="renameModal">
    <div class="modal-box">
        <h2>Rename Bracket</h2>
        <p>Update your bracket name. This works for both saved and submitted brackets.</p>
        <input type="hidden" id="renameBracketId" value="">
        <label class="modal-label">Bracket Name</label>
        <input class="modal-input" id="renameBracketName" type="text" maxlength="50">
        <div class="modal-char-count"><span id="renameCharCount">0</span> / 50</div>
        <div class="modal-actions">
            <button class="modal-cancel" id="renameCancel">Cancel</button>
            <button class="modal-confirm" id="renameConfirm">üíæ Save Name</button>
        </div>
    </div>
</div>

<!-- JS -->
<script>
const allData     = {{ (submitted + saved) | map(attribute='bracket_data') | list | tojson }};
const allIds      = {{ (submitted + saved) | map(attribute='id')           | list | tojson }};
const trueResults = {{ (true_results or {}) | tojson }};

const ROUND_ORDER = [
    ["west_r64","west_r32"],["west_r32","west_s16"],["west_s16","west_e8"],["west_e8","ff_left"],
    ["south_r64","south_r32"],["south_r32","south_s16"],["south_s16","south_e8"],["south_e8","ff_left"],
    ["east_r64","east_r32"],["east_r32","east_s16"],["east_s16","east_e8"],["east_e8","ff_right"],
    ["midwest_r64","midwest_r32"],["midwest_r32","midwest_s16"],["midwest_s16","midwest_e8"],["midwest_e8","ff_right"],
    ["ff_left","championship"],["ff_right","championship"]
];
const CONTAINERS = [
    "west_r64","west_r32","west_s16","west_e8",
    "south_r64","south_r32","south_s16","south_e8",
    "east_r64","east_r32","east_s16","east_e8",
    "midwest_r64","midwest_r32","midwest_s16","midwest_e8",
    "ff_left","ff_right","championship"
];
const ROUND_DEPTH = {
    "west_r64":0,"south_r64":0,"east_r64":0,"midwest_r64":0,
    "west_r32":1,"south_r32":1,"east_r32":1,"midwest_r32":1,
    "west_s16":2,"south_s16":2,"east_s16":2,"midwest_s16":2,
    "west_e8":3,"south_e8":3,"east_e8":3,"midwest_e8":3,
    "ff_left":4,"ff_right":4,"championship":5
};

function buildBustedTeams(data) {
    const realLostAt = new Map();
    const eliminatedBy = new Map();
    CONTAINERS.forEach(cid => {
        const realWinners = trueResults[cid];
        if (!realWinners || !realWinners.length) return;
        const teams = data[cid];
        if (!teams || !teams.length) return;
        const depth = ROUND_DEPTH[cid];
        if (depth === undefined) return;
        for (let i = 0; i + 1 < teams.length; i += 2) {
            const realWinner = realWinners[i / 2];
            if (!realWinner) continue;
            const n1 = typeof teams[i]   === 'string' ? teams[i]   : teams[i]?.name;
            const n2 = typeof teams[i+1] === 'string' ? teams[i+1] : teams[i+1]?.name;
            if (n1 && n1 !== realWinner && !realLostAt.has(n1)) {
                realLostAt.set(n1, depth);
                eliminatedBy.set(n1, realWinner);
            }
            if (n2 && n2 !== realWinner && !realLostAt.has(n2)) {
                realLostAt.set(n2, depth);
                eliminatedBy.set(n2, realWinner);
            }
        }
    });
    const userLastRound = new Map();
    CONTAINERS.forEach(cid => {
        const depth = ROUND_DEPTH[cid];
        if (depth === undefined) return;
        (data[cid] || []).forEach(t => {
            const name = typeof t === 'string' ? t : t?.name;
            if (!name) return;
            if (!userLastRound.has(name) || depth > userLastRound.get(name)) userLastRound.set(name, depth);
        });
    });
    if (data.champion) {
        const n = data.champion, d = 6;
        if (!userLastRound.has(n) || d > userLastRound.get(n)) userLastRound.set(n, d);
    }
    const busted = new Map();
    realLostAt.forEach((lostDepth, name) => {
        if (lostDepth < (userLastRound.get(name) ?? lostDepth)) busted.set(name, lostDepth);
    });
    return {busted, eliminatedBy};
}

function teamClasses(w1, w2, n1, n2, slotIndex, cid, bustedData) {
    const { busted, eliminatedBy } = bustedData;
    const userPick = w1 ? n1 : w2 ? n2 : null;
    const actualWinner = (trueResults[cid] || [])[slotIndex];
    let c1 = '', c2 = '', check1 = false, check2 = false;
    if (actualWinner) {
        const correct = userPick === actualWinner;
        c1 = (correct && n1 === userPick) ? ' correct' : (!correct && n1 === actualWinner) ? ' incorrect-actual' : '';
        c2 = (correct && n2 === userPick) ? ' correct' : (!correct && n2 === actualWinner) ? ' incorrect-actual' : '';
        check1 = correct && n1 === userPick;
        check2 = correct && n2 === userPick;
    }
    const depth = ROUND_DEPTH[cid] ?? -1;
    const bust1 = busted.has(n1) && depth >= busted.get(n1);
    const bust2 = busted.has(n2) && depth >= busted.get(n2);
    if (bust1) c1 += ' busted';
    if (bust2) c2 += ' busted';
    const bustLabel1 = bust1 ? (eliminatedBy.get(n1) || null) : null;
    const bustLabel2 = bust2 ? (eliminatedBy.get(n2) || null) : null;
    return { c1, c2, check1, check2, bustLabel1, bustLabel2 };
}

function renderBracket(data, bid) {
    const bustedData = buildBustedTeams(data);
    CONTAINERS.forEach(cid => {
        const teams = data[cid];
        if (!teams || !teams.length) return;
        const winners = new Set();
        ROUND_ORDER.filter(([c]) => c === cid).forEach(([, nxt]) => {
            (data[nxt] || []).forEach(t => winners.add(typeof t === 'string' ? t : t.name));
        });
        if (cid === 'championship' && data.champion) winners.add(data.champion);
        const container = document.getElementById(cid + '_' + bid);
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i + 1 < teams.length; i += 2) {
            const t1 = teams[i], t2 = teams[i+1];
            const n1 = typeof t1 === 'string' ? t1 : t1.name;
            const s1 = typeof t1 === 'string' ? '' : (t1.seed || '');
            const n2 = typeof t2 === 'string' ? t2 : t2.name;
            const s2 = typeof t2 === 'string' ? '' : (t2.seed || '');
            const w1 = winners.has(n1), w2 = winners.has(n2);
            const { c1, c2, check1, check2, bustLabel1, bustLabel2 } = teamClasses(w1, w2, n1, n2, i/2, cid, bustedData);
            const div = document.createElement('div');
            div.className = 'matchup';
            div.innerHTML =
                `<div class="team ${w1?'selected':w2?'eliminated':''}${c1}">
                    <span class="seed">${s1}</span><span class="team-name">${n1}</span>${check1?' <span class="check-mark">‚úì</span>':''}${bustLabel1?` <span class="bust-actual">${bustLabel1}</span>`:''}
                </div>` +
                `<div class="team ${w2?'selected':w1?'eliminated':''}${c2}">
                    <span class="seed">${s2}</span><span class="team-name">${n2}</span>${check2?' <span class="check-mark">‚úì</span>':''}${bustLabel2?` <span class="bust-actual">${bustLabel2}</span>`:''}
                </div>`;
            container.appendChild(div);
        }
    });
    const ch = document.getElementById('champion_' + bid);
    const actualChamp = (trueResults['championship'] || [])[0];
    if (ch && data.champion) {
        const champBusted = bustedData.busted.has(data.champion) && 6 >= bustedData.busted.get(data.champion);
        const nameHtml = champBusted
            ? `<span class="team-name" style="text-decoration:line-through;opacity:0.6;">${data.champion}</span>`
            : data.champion;
        ch.innerHTML = actualChamp && data.champion === actualChamp
            ? nameHtml + ' <span class="check-mark">‚úì</span>'
            : actualChamp && data.champion !== actualChamp
                ? nameHtml + ` <span class="bust-actual">${actualChamp}</span>`
                : nameHtml;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    allData.forEach((d, i) => renderBracket(d, allIds[i]));
});

/* Region tab switching */
document.querySelectorAll('.bracket-container-inner').forEach(container => {
    container.querySelectorAll('.bracket-region-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const region = tab.dataset.region;
            container.querySelectorAll('.bracket-region-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.bracket-region-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            container.querySelector(`.bracket-region-panel[data-region="${region}"]`)?.classList.add('active');
        });
    });
});

/* Bracket tab switching */
document.querySelectorAll('.bracket-tab').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.bracket-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.bracket-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.id)?.classList.add('active');
        document.getElementById('viewerTitle').textContent = btn.dataset.name;
    });
});

/* View links ‚Äî scroll to viewer and activate the right tab */
document.querySelectorAll('.bracket-viewer-link').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const tab = document.querySelector(`.bracket-tab[data-id="${link.dataset.id}"]`);
        if (tab) tab.click();
        document.getElementById('viewer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
});

/* Submit modal */
const submitModal     = document.getElementById('submitModal');
const submitBracketId = document.getElementById('submitBracketId');
const submitNameInput = document.getElementById('submitBracketName');
const submitCharCount = document.getElementById('submitCharCount');
const modalCancel     = document.getElementById('modalCancel');
const modalConfirm    = document.getElementById('modalConfirm');

function openSubmitModal(bracketId, currentName) {
    submitBracketId.value = bracketId;
    submitNameInput.value = currentName;
    submitCharCount.textContent = currentName.length;
    submitModal.classList.add('open');
    submitNameInput.focus();
}
document.querySelectorAll('.open-submit-modal-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        openSubmitModal(parseInt(btn.dataset.bracketId, 10), btn.dataset.bracketName || '');
    });
});

modalCancel.addEventListener('click', () => submitModal.classList.remove('open'));
submitModal.addEventListener('click', e => { if (e.target === submitModal) submitModal.classList.remove('open'); });
submitNameInput.addEventListener('input', () => { submitCharCount.textContent = submitNameInput.value.length; });

modalConfirm.addEventListener('click', () => {
    const bracketName = submitNameInput.value.trim() || 'My Bracket';
    if (!confirm('Once bracket is submitted it cannot be changed or unsubmitted')) return;
    modalConfirm.disabled = true;
    modalConfirm.textContent = 'Submitting‚Ä¶';
    fetch('/submit_bracket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bracket_id: parseInt(submitBracketId.value), bracket_name: bracketName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) { alert(data.error); }
        else { window.location.reload(); }
    })
    .catch(() => alert('Submission failed. Please try again.'))
    .finally(() => {
        modalConfirm.disabled = false;
        modalConfirm.textContent = 'üèÜ Submit to Leaderboard';
        submitModal.classList.remove('open');
    });
});

/* Rename bracket */
const renameModal = document.getElementById('renameModal');
const renameBracketId = document.getElementById('renameBracketId');
const renameNameInput = document.getElementById('renameBracketName');
const renameCharCount = document.getElementById('renameCharCount');
const renameCancel = document.getElementById('renameCancel');
const renameConfirm = document.getElementById('renameConfirm');

function openRenameModal(bracketId, currentName) {
    renameBracketId.value = bracketId;
    renameNameInput.value = currentName || '';
    renameCharCount.textContent = renameNameInput.value.length;
    renameModal.classList.add('open');
    renameNameInput.focus();
}

document.querySelectorAll('.open-rename-modal-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        openRenameModal(parseInt(btn.dataset.bracketId, 10), btn.dataset.bracketName || '');
    });
});

renameCancel.addEventListener('click', () => renameModal.classList.remove('open'));
renameModal.addEventListener('click', e => { if (e.target === renameModal) renameModal.classList.remove('open'); });
renameNameInput.addEventListener('input', () => { renameCharCount.textContent = renameNameInput.value.length; });
renameNameInput.addEventListener('keydown', e => { if (e.key === 'Enter') renameConfirm.click(); });

renameConfirm.addEventListener('click', () => {
    const bracketName = renameNameInput.value.trim();
    if (!bracketName) {
        alert('Please enter a bracket name.');
        renameNameInput.focus();
        return;
    }

    renameConfirm.disabled = true;
    renameConfirm.textContent = 'Saving‚Ä¶';

    fetch('/rename_bracket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bracket_id: parseInt(renameBracketId.value, 10), bracket_name: bracketName })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) { alert(data.error); }
        else { window.location.reload(); }
    })
    .catch(() => alert('Rename failed. Please try again.'))
    .finally(() => {
        renameConfirm.disabled = false;
        renameConfirm.textContent = 'üíæ Save Name';
    });
});

/* Delete saved bracket */
function deleteBracket(bracketId, btn) {
    if (!confirm('Delete this saved bracket? This cannot be undone.')) return;
    btn.disabled = true;
    fetch('/delete_bracket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bracket_id: bracketId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) { alert(data.error); btn.disabled = false; }
        else { window.location.reload(); }
    })
    .catch(() => { alert('Delete failed.'); btn.disabled = false; });
}
</script>

</body>
</html>